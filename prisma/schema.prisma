// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Country {
  id           String    @id @default(uuid())
  name         String
  iso2         String    @unique @db.Char(2)
  iso3         String    @unique @db.Char(3)
  numericCode  String?   @db.Char(3)
  continent    Continent
  currencyCode String?   @db.Char(3)
  phoneCode    String
  flagEmoji    String?
  isActive     Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([name])
  @@index([continent])
  @@index([iso2])
}

model Ticket {
  id        String @id @default(uuid())
  bookingId String

  passengerId String

  ticketNumber String
  provider     String
  issuedAt     DateTime

  createdAt DateTime @default(now())

  passenger Passenger @relation(fields: [passengerId], references: [id])
  booking   Booking   @relation(fields: [bookingId], references: [id])
}

model PaymentEvent {
  id        String  @id @default(uuid())
  paymentId String
  payment   Payment @relation(fields: [paymentId], references: [id])

  stripeEventId String @unique
  type          String
  payload       Json

  createdAt DateTime @default(now())

  @@index([stripeEventId])
}

model Payment {
  id        String  @id @default(uuid())
  bookingId String
  booking   Booking @relation(fields: [bookingId], references: [id])

  provider        PaymentProvider @default(STRIPE)
  paymentIntentId String          @unique
  amount          Int // cents
  currency        String

  status        PaymentStatus
  failureReason String?

  capturedAt DateTime?
  refundedAt DateTime?

  events PaymentEvent[]

  createdAt DateTime @default(now())

  @@index([paymentIntentId])
}

model Passenger {
  id        String @id @default(uuid())
  bookingId String

  passengerType PassengerType
  title         Title
  firstName     String
  lastName      String
  gender        Gender

  email       String
  phoneNumber String

  dateOfBirth    DateTime?
  passportNumber String
  issuingDate    DateTime?
  passportExpiry DateTime?
  nationality    String // ISO 2 code
  issuingCountry String // ISO 2 code

  holder Boolean

  createdAt DateTime @default(now())
  booking   Booking  @relation(fields: [bookingId], references: [id])

  tickets Ticket[]
}

model BookingOTP {
  id        String   @id @default(cuid())
  bookingId String   @unique
  otpHash   String
  expiresAt DateTime
  attempts  Int      @default(0)
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
}

model Booking {
  id                    String        @id @default(uuid())
  referenceCode         String        @unique
  providerFlightId      String
  userId                String?
  status                BookingStatus @default(DRAFT)
  totalAmount           Decimal
  currency              CurrencyType  @default(DOLLAR)
  departureCity         String?
  arrivalCity           String?
  departureDate         DateTime?
  travellerCount        Int?
  provider              String // "tiqwa"
  providerBookingId     String?
  contactEmail          String
  contactPhone          String
  stripePaymentIntentId String?
  expiresAt             DateTime?
  paidAt                DateTime?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  passengers Passenger[]
  payments   Payment[]
  tickets    Ticket[]

  bookingOTPs BookingOTP[]
}

enum Continent {
  AFRICA
  EUROPE
  ASIA
  NORTH_AMERICA
  SOUTH_AMERICA
  OCEANIA
  ANTARCTICA
}

enum BookingStatus {
  DRAFT
  PENDING_PAYMENT
  PAID
  TICKETING
  TICKETED
  FAILED_TICKETING
  CANCELLED
  REFUNDED
}

enum PassengerType {
  ADULT
  CHILD
}

enum Title {
  MR
  MRS
  MS
  MISS
  MSTR
}

enum Gender {
  MALE
  FEMALE
}

enum PaymentStatus {
  REQUIRES_PAYMENT
  REQUIRES_ACTION
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentProvider {
  STRIPE
}

enum CurrencyType {
  NAIRA
  DOLLAR
  POUND
  EURO
  CNY
}
